#!/usr/bin/env bash
# shellcheck shell=bash
# shellcheck disable=SC2034

if [[ $(uname) == "Darwin" ]]; then
  # ICHRISBIRCH_HOME="/usr/local/var/www/ichrisbirch"
  ICHRISBIRCH_HOME="$HOME/code/ichrisbirch"
  LOG_DIR="/usr/local/var/log/ichrisbirch"
else
  ICHRISBIRCH_HOME="/srv/ichrisbirch"
  LOG_DIR="/var/log/ichrisbirch"
fi

export LOG_DIR

red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
blue=$(tput setaf 4)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)
gray=$(tput setaf 8)
bright_red=$(tput setaf 9)
bright_green=$(tput setaf 10)
bright_yellow=$(tput setaf 11)
bright_blue=$(tput setaf 12)
bright_magenta=$(tput setaf 13)
bright_cyan=$(tput setaf 14)
orange=$(tput setaf 208) # 256-color orange
reset=$(tput sgr0)

function colored-logs() {
  local RED_ERROR="${red}[ERROR]${reset}"
  local YELLOW_WARNING="${yellow}[WARNING]${reset}"
  local BLUE_INFO="${blue}[INFO]${reset}"
  local GREEN_DEBUG="${green}[DEBUG]${reset}"
  local MAGENTA_CRITICAL="${magenta}[CRITICAL]${reset}"

  # Service name colors
  local RED_REDIS="${red}redis${reset}"
  local GREEN_POSTGRES="${green}postgres${reset}"
  local CYAN_NGINX="${cyan}nginx${reset}"
  local BRIGHT_GREEN_API="${bright_green}api${reset}"
  local BRIGHT_BLUE_APP="${bright_blue}app${reset}"
  local ORANGE_CHAT="${orange}chat${reset}"
  local YELLOW_SCHEDULER="${yellow}scheduler${reset}"

  # Use sed with proper escaping for backslashes
  sed \
    -e 's/ichrisbirch-//g' \
    -e 's/-dev//g' \
    -e 's/-test//g' \
    -e 's/^api[ ]*|/'"${BRIGHT_GREEN_API}"' |/' \
    -e 's/^app[ ]*|/'"${BRIGHT_BLUE_APP}"' |/' \
    -e 's/^redis[ ]*|/'"${RED_REDIS}"' |/' \
    -e 's/^postgres[ ]*|/'"${GREEN_POSTGRES}"' |/' \
    -e 's/^nginx[ ]*|/'"${CYAN_NGINX}"' |/' \
    -e 's/^chat[ ]*|/'"${ORANGE_CHAT}"' |/' \
    -e 's/^scheduler[ ]*|/'"${YELLOW_SCHEDULER}"' |/' \
    -e 's/\[ERROR\]/'"${RED_ERROR}"'/g' \
    -e 's/\[WARNING\]/'"${YELLOW_WARNING}"'/g' \
    -e 's/\[DEBUG\]/'"${GREEN_DEBUG}"'/g' \
    -e 's/\[INFO\]/'"${BLUE_INFO}"'/g' \
    -e 's/\[CRITICAL\]/'"${MAGENTA_CRITICAL}"'/g'
}

function colored-status() {
  local GREEN_RUNNING="${green}running${reset}"
  local RED_EXITED="${red}exited${reset}"
  local YELLOW_RESTARTING="${yellow}restarting${reset}"
  local BLUE_PAUSED="${blue}paused${reset}"
  local MAGENTA_DEAD="${magenta}dead${reset}"
  local CYAN_CREATED="${cyan}created${reset}"
  local YELLOW_UNHEALTHY="${yellow}unhealthy${reset}"
  local GREEN_HEALTHY="${green}healthy${reset}"

  awk -v running="$GREEN_RUNNING" \
    -v exited="$RED_EXITED" \
    -v restarting="$YELLOW_RESTARTING" \
    -v paused="$BLUE_PAUSED" \
    -v dead="$MAGENTA_DEAD" \
    -v created="$CYAN_CREATED" \
    -v unhealthy="$YELLOW_UNHEALTHY" \
    -v healthy="$GREEN_HEALTHY" '
    {
        # Strip ichrisbirch- prefix from service names
        gsub(/ichrisbirch-/, "");
        # Color container states using gsub for all matches
        gsub(/running/, running);
        gsub(/exited/, exited);
        gsub(/restarting/, restarting);
        gsub(/paused/, paused);
        gsub(/dead/, dead);
        gsub(/created/, created);
        gsub(/unhealthy/, unhealthy);
        gsub(/healthy/, healthy);
        print $0;
    }'
}

function logs() {
  cd "$LOG_DIR" || exit
  ls -lH
  exec $SHELL
}

function install() {
  sudo ln -sf "$ICHRISBIRCH_HOME/cli/ichrisbirch" /usr/local/bin/ichrisbirch
}

function open() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Opening ${green}ichrisbirch${reset} project in VS Code"
  code .
  echo "Starting tmux session"
  exec tmux new-session -d -s ichrisbirch || tmux attach-session -t ichrisbirch
}

function project-cd() {
  cd "$ICHRISBIRCH_HOME" || exit
  if [ -d ".venv" ]; then
    echo "Activating virtual environment"
    # shellcheck source=/dev/null
    source .venv/bin/activate
  fi
  exec "$SHELL"
}

# ============================================================================
# SSL CERTIFICATE MANAGEMENT
# ============================================================================

function ssl-manager() {
  local action="${1:-info}"
  local environment="${2:-all}"

  cd "$ICHRISBIRCH_HOME" || exit

  if [ -x "./deploy-containers/traefik/scripts/ssl-manager.sh" ]; then
    ./deploy-containers/traefik/scripts/ssl-manager.sh "$action" "$environment"
  else
    echo "${red}SSL manager script not found${reset}"
    echo "Expected: ${cyan}./deploy-containers/traefik/scripts/ssl-manager.sh${reset}"
    return 1
  fi
}

function dev-start() {
  cd "$ICHRISBIRCH_HOME" || exit

  # Ensure proxy network exists for Traefik
  if ! docker network inspect proxy >/dev/null 2>&1; then
    echo "Creating external proxy network..."
    docker network create proxy
  fi

  echo "Starting ${blue}DEV${reset} environment with ${green}Docker Compose + Traefik (HTTPS)${reset}"
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml up -d

  echo ""
  echo "Development environment started with ${green}HTTPS${reset}:"
  echo "  ${green}API${reset}:       ${cyan}https://api.docker.localhost/${reset}"
  echo "  ${green}APP${reset}:       ${cyan}https://app.docker.localhost/${reset}"
  echo "  ${green}CHAT${reset}:      ${cyan}https://chat.docker.localhost/${reset}"
  echo "  ${green}DASHBOARD${reset}: ${cyan}https://dashboard.docker.localhost/${reset} (user: dev, pass: devpass)"
  echo ""
  echo "Legacy HTTP access also available:"
  echo "  ${green}APP${reset}: ${cyan}http://localhost:5000${reset}"
  echo "  ${green}API${reset}: ${cyan}http://localhost:8000${reset}"
  echo "  ${green}CHAT${reset}: ${cyan}http://localhost:8505${reset}"
  echo "  ${green}PostgreSQL${reset}: ${cyan}localhost:5432${reset}"
  echo "  ${green}Redis${reset}: ${cyan}localhost:6379${reset}"
  echo ""
  echo "Use ${blue}ichrisbirch dev logs${reset} to view live container logs"
  echo "Use ${blue}ichrisbirch dev status${reset} to check service status"
  echo "Use ${blue}ichrisbirch dev health${reset} to run health checks"
}

function dev-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Stopping ${blue}DEV${reset} environment"
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml down
}

function dev-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Restarting ${blue}DEV${reset} environment"
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml restart
}

function dev-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Rebuilding and restarting ${blue}DEV${reset} environment"
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml down
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml up -d --build
}

function dev-logs() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ” Viewing ${blue}DEV${reset} Docker container logs..."
  echo "Note: Application logs are in ${cyan}$LOG_DIR/{app,api,scheduler,chat}.log${reset}"

  # Show live Docker Compose logs with color formatting and clean service names
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml logs --follow --tail=50 | colored-logs
}

function dev-status() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ“Š ${blue}DEV${reset} environment status:"
  echo ""

  # Show container status with colors
  docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status

  echo ""
  echo "ðŸŒ ${blue}Development${reset} URLs:"
  echo "  â€¢ API:       https://api.docker.localhost/"
  echo "  â€¢ App:       https://app.docker.localhost/"
  echo "  â€¢ Chat:      https://chat.docker.localhost/"
  echo "  â€¢ Dashboard: https://dashboard.docker.localhost/ (user: dev, pass: devpass)"
}

function dev-monitor() {
  tmuxinator ichrisbirch-dev-monitoring
}

function dev-health() {
  echo "ðŸ¥ Running health check for ${blue}DEV${reset} environment"

  cd "$ICHRISBIRCH_HOME" || exit

  if [ -x "./deploy-containers/traefik/scripts/health-check.sh" ]; then
    ./deploy-containers/traefik/scripts/health-check.sh dev
  else
    echo "${red}Health check script not found${reset}"
    echo "Expected: ${cyan}./deploy-containers/traefik/scripts/health-check.sh${reset}"
    return 1
  fi
}

function test-run() {
  cd "$ICHRISBIRCH_HOME" || exit
  mkdir -p "$ICHRISBIRCH_HOME/test-logs"
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"
  export ENVIRONMENT=testing

  # If no arguments, run all tests
  # Otherwise, pass all arguments to pytest
  if [ $# -eq 0 ]; then
    uv run pytest
  else
    uv run pytest "$@"
  fi
}

function test-cov() {
  cd "$ICHRISBIRCH_HOME" || exit
  mkdir -p "$ICHRISBIRCH_HOME/test-logs"
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"
  export ENVIRONMENT=testing

  # Run pytest with coverage
  if [ $# -eq 0 ]; then
    uv run pytest --cov=ichrisbirch --cov-report=html
  else
    uv run pytest --cov=ichrisbirch --cov-report=html "$@"
  fi
  echo ""
  echo "Coverage report: ${cyan}file://$ICHRISBIRCH_HOME/htmlcov/index.html${reset}"
}

function testing-start() {
  cd "$ICHRISBIRCH_HOME" || exit

  # Create test-logs directory if it doesn't exist
  mkdir -p "$ICHRISBIRCH_HOME/test-logs"

  # Ensure proxy network exists for Traefik
  if ! docker network inspect proxy >/dev/null 2>&1; then
    echo "Creating external proxy network..."
    docker network create proxy
  fi

  echo "Starting ${blue}TESTING${reset} environment with ${green}Docker Compose + Traefik (HTTPS)${reset}"
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml up -d

  echo "Waiting for services to be ready..."
  sleep 15

  echo "Initializing test database..."
  # Use virtual environment and run database initialization
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"

  # Run test database initialization from host (need to use localhost, not Docker hostname)
  if ENVIRONMENT=testing uv run python -m ichrisbirch.database.initialization --env testing --db-host localhost --db-port 5434; then
    echo "${green}âœ“${reset} Database initialized successfully"
  else
    echo "${red}âœ—${reset} Database initialization failed"
    echo "Check logs for details. You may need to run:"
    echo "   ${blue}ichrisbirch testing stop${reset}"
    echo "   ${blue}ichrisbirch testing start${reset}"
    return 1
  fi

  echo ""
  echo "Testing environment started with ${green}HTTPS${reset}:"
  echo "  ${green}API${reset}:       ${cyan}https://api.test.localhost:8443/${reset}"
  echo "  ${green}APP${reset}:       ${cyan}https://app.test.localhost:8443/${reset}"
  echo "  ${green}CHAT${reset}:      ${cyan}https://chat.test.localhost:8443/${reset}"
  echo "  ${green}DASHBOARD${reset}: ${cyan}https://dashboard.test.localhost:8443/${reset} (user: test, pass: testpass)"
  echo ""
  echo "Legacy HTTP access also available:"
  echo "  ${green}APP${reset}: ${cyan}http://localhost:5001${reset}"
  echo "  ${green}API${reset}: ${cyan}http://localhost:8001${reset}"
  echo "  ${green}CHAT${reset}: ${cyan}http://localhost:8507${reset}"
  echo "  ${green}PostgreSQL${reset}: ${cyan}localhost:5434${reset}"
  echo "  ${green}Redis${reset}: ${cyan}localhost:6380${reset}"
  echo ""
  echo "ðŸ“ Test logs available at: ${cyan}$ICHRISBIRCH_HOME/test-logs/${reset}"
  echo "Use ${blue}ichrisbirch testing app-logs${reset} to view application logs"
  echo "Use ${blue}ichrisbirch testing logs${reset} to view Docker container logs"
  echo "Use ${blue}ichrisbirch testing health${reset} to run health checks"
}

function testing-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Stopping ${blue}TESTING${reset} environment"
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml down
}

function testing-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Restarting ${blue}TESTING${reset} environment"
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml restart
}

function testing-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Rebuilding and restarting ${blue}TESTING${reset} environment"
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml down
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml up -d --build
}

function testing-logs() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ” Viewing ${blue}TESTING${reset} Docker container logs..."
  echo "Note: Application logs are in ${cyan}$LOG_DIR/{app,api,scheduler,chat}.log${reset}"

  # Show live Docker Compose logs with color formatting and clean service names
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml logs --follow --tail=50 | colored-logs
}

function testing-app-logs() {
  local lines="${1:-100}"
  local follow_flag=""

  # Check if --follow is passed as first or second argument
  if [[ "$1" == "--follow" ]] || [[ "$2" == "--follow" ]]; then
    follow_flag="--follow"
    # Adjust lines if --follow was passed as first argument
    if [[ "$1" == "--follow" ]]; then
      lines="${2:-100}"
    fi
  fi

  cd "$ICHRISBIRCH_HOME" || exit
  local test_logs_dir="$ICHRISBIRCH_HOME/test-logs"
  local log_file="$test_logs_dir/testing.log"

  # Check if test logs directory exists
  if [[ ! -d "$test_logs_dir" ]]; then
    echo "${red}âŒ Test logs directory not found: $test_logs_dir${reset}"
    echo "${cyan}ðŸ’¡ Make sure the test environment has been started at least once:${reset}"
    echo "   ${blue}ichrisbirch testing start${reset}"
    return 1
  fi

  # Check if consolidated log file exists
  if [[ ! -f "$log_file" ]]; then
    echo "${red}âŒ Test log file not found: $log_file${reset}"
    echo "${cyan}ðŸ’¡ Make sure the test environment is running to generate logs:${reset}"
    echo "   ${blue}ichrisbirch testing start${reset}"
    return 1
  fi

  echo "ðŸ“– Viewing ${blue}TESTING${reset} application logs from: ${cyan}$log_file${reset}"

  if [[ -n "$follow_flag" ]]; then
    echo "   Mode: ${green}Follow${reset} (press Ctrl+C to exit)"
    echo ""
    tail -f "$log_file" | colored-logs
  else
    echo "   Lines: $lines"
    echo ""
    tail -n "$lines" "$log_file" | colored-logs
  fi
}

function testing-app-logs-follow() {
  testing-app-logs --follow
}

function testing-status() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ“Š ${blue}TESTING${reset} environment status:"
  echo ""

  # Show container status with colors
  docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status

  echo ""
  echo "ðŸŒ ${blue}Test${reset} URLs:"
  echo "  â€¢ API:       https://api.test.localhost:8443/"
  echo "  â€¢ App:       https://app.test.localhost:8443/"
  echo "  â€¢ Chat:      https://chat.test.localhost:8443/"
  echo "  â€¢ Dashboard: https://dashboard.test.localhost:8443/ (user: test, pass: testpass)"
}

function testing-health() {
  echo "ðŸ¥ Running health check for ${blue}TESTING${reset} environment"

  cd "$ICHRISBIRCH_HOME" || exit

  if [ -x "./deploy-containers/traefik/scripts/health-check.sh" ]; then
    ./deploy-containers/traefik/scripts/health-check.sh test
  else
    echo "${red}Health check script not found${reset}"
    echo "Expected: ${cyan}./deploy-containers/traefik/scripts/health-check.sh${reset}"
    return 1
  fi
}

function prod-start() {
  cd "$ICHRISBIRCH_HOME" || exit

  # Ensure proxy network exists for Traefik
  if ! docker network inspect proxy >/dev/null 2>&1; then
    echo "Creating external proxy network..."
    docker network create proxy
  fi

  echo "Starting ${magenta}PRODUCTION${reset} environment with ${green}Docker Compose + Traefik (HTTPS)${reset}"
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml up -d

  echo ""
  echo "Production environment started with ${green}HTTPS${reset}:"
  echo "  ${green}API${reset}:       ${cyan}https://api.yourdomain.local/${reset}"
  echo "  ${green}APP${reset}:       ${cyan}https://app.yourdomain.local/${reset}"
  echo "  ${green}CHAT${reset}:      ${cyan}https://chat.yourdomain.local/${reset}"
  echo "  ${yellow}Note${reset}: Update domains in production config as needed"
  echo ""
  echo "Use ${blue}ichrisbirch prod logs${reset} to view live container logs"
  echo "Use ${blue}ichrisbirch prod status${reset} to check service status"
  echo "Use ${blue}ichrisbirch prod health${reset} to run health checks"
}

function prod-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Stopping ${magenta}PRODUCTION${reset} environment"
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml down
}

function prod-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Restarting ${magenta}PRODUCTION${reset} environment"
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml restart
}

function prod-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Rebuilding and restarting ${magenta}PRODUCTION${reset} environment"
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml down
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml up -d --build
}

function prod-monitor() {
  tmuxinator ichrisbirch-prod-monitoring
}

function prod-logs() {
  echo "ðŸ” Viewing ${magenta}PRODUCTION${reset} Docker container logs..."
  echo "Note: Production uses Docker Compose services"
  cd "$ICHRISBIRCH_HOME" || exit

  # Show live Docker Compose logs with color formatting and clean service names
  docker compose --project-name ichrisbirch-prod -f docker-compose.yml logs --follow --tail=50 | colored-logs
}

function prod-status() {
  echo "ðŸ“Š ${magenta}PRODUCTION${reset} environment status:"
  echo ""

  # Check if this is production environment
  if [ -f "$ICHRISBIRCH_HOME/docker-compose.yml" ]; then
    cd "$ICHRISBIRCH_HOME" || exit
    docker compose --project-name ichrisbirch-prod -f docker-compose.yml ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status

    echo ""
    echo "ðŸŒ ${magenta}Production${reset} URLs (replace yourdomain.local with your actual domain):"
    echo "  â€¢ API:       https://api.yourdomain.local/"
    echo "  â€¢ App:       https://app.yourdomain.local/"
    echo "  â€¢ Chat:      https://chat.yourdomain.local/"
  else
    echo "${yellow}Production Docker Compose files not found${reset}"
    echo "Checking traditional supervisor processes..."
    sudo supervisorctl status 2>/dev/null || echo "Supervisor not running"
  fi
}

function prod-health() {
  echo "ðŸ¥ Running health check for ${magenta}PRODUCTION${reset} environment"

  cd "$ICHRISBIRCH_HOME" || exit

  if [ -x "./deploy-containers/traefik/scripts/health-check.sh" ]; then
    ./deploy-containers/traefik/scripts/health-check.sh prod
  else
    echo "${red}Health check script not found${reset}"
    echo "Expected: ${cyan}./deploy-containers/traefik/scripts/health-check.sh${reset}"
    return 1
  fi
}

function prod-apihealth() {
  curl --silent https://api.ichrisbirch.com/health/ | jq
}

function prod-reboot-ec2() {
  instance_name=${1:-ichrisbirch-webserver}
  echo "Looking for instance with name '$instance_name'"
  instance_id=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$instance_name" --query "Reservations[*].Instances[*].InstanceId" --output text)
  if [ -z "$instance_id" ]; then
    echo "${red}No instance found with the name '$instance_name'${reset}"
    echo "${green}Current running instances:${reset}"
    aws ec2 describe-instances --query "Reservations[*].Instances[*].[InstanceId,Tags[?Key=='Name'].Value]" --output text
  fi
  echo "Rebooting the ec2 instance with the name '$instance_name'"
  aws ec2 reboot-instances --instance-ids "$instance_id"
}

# ============================================================================
# PROJECT STATS
# ============================================================================

function stats-show() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ“Š Current Project Stats"
  echo ""
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"
  uv run python -m scripts.stats.collect
}

function stats-collect() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸ“Š Collecting and saving stats for current commit..."
  echo ""
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"
  uv run python -m scripts.stats.collect --commit
}

function stats-sync() {
  cd "$ICHRISBIRCH_HOME" || exit
  local action="${1:-}"
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"

  case "$action" in
  push)
    echo "ðŸ“¤ Pushing stats to S3..."
    uv run python -m scripts.stats.sync push
    ;;
  pull)
    echo "ðŸ“¥ Pulling stats from S3..."
    uv run python -m scripts.stats.sync pull
    ;;
  *)
    echo "ðŸ”„ Syncing stats with S3 (pull then push)..."
    uv run python -m scripts.stats.sync
    ;;
  esac
}

function stats-history() {
  cd "$ICHRISBIRCH_HOME" || exit
  local count="${1:-10}"
  echo "ðŸ“ˆ Recent stats history (last $count commits):"
  echo ""

  # List stats files sorted by date
  if [ -d "$ICHRISBIRCH_HOME/stats" ]; then
    find "$ICHRISBIRCH_HOME/stats" -maxdepth 1 -name "stats_*.json" -type f -print0 2>/dev/null | xargs -0 ls -t | head -n "$count" | while read -r file; do
      if [ -f "$file" ]; then
        # Extract info from JSON
        commit=$(jq -r '.commit.short' "$file" 2>/dev/null)
        date=$(jq -r '.commit.date' "$file" 2>/dev/null | cut -d'T' -f1)
        message=$(jq -r '.commit.message' "$file" 2>/dev/null | head -c 40)
        tests=$(jq -r '.tests.total' "$file" 2>/dev/null)
        coverage=$(jq -r '.coverage.line_percent' "$file" 2>/dev/null)
        code=$(jq -r '.code.total.code' "$file" 2>/dev/null)

        printf "${cyan}%s${reset} %s  ${green}%s${reset} tests  ${yellow}%.1f%%${reset} cov  ${blue}%s${reset} LOC  %s\n" \
          "$commit" "$date" "$tests" "$coverage" "$code" "$message"
      fi
    done
  else
    echo "No stats directory found. Run ${blue}ichrisbirch stats sync pull${reset} to fetch stats."
  fi
}

# ============================================================================
# DEVELOPER JOURNEY
# ============================================================================

function journey-current() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "ðŸš€ Current Commit Session"
  echo ""

  # Get current branch and session file
  local branch
  branch=$(git branch --show-current)
  local safe_branch="${branch//\//-}"
  local session_file="$ICHRISBIRCH_HOME/.tmp/session-${safe_branch}.json"

  if [ -f "$session_file" ]; then
    local attempts
    attempts=$(jq '.attempts | length' "$session_file" 2>/dev/null)
    local started
    started=$(jq -r '.started_at' "$session_file" 2>/dev/null | cut -d'T' -f1,2 | tr 'T' ' ' | cut -d'+' -f1)
    local files
    files=$(jq '.staged_files | length' "$session_file" 2>/dev/null)

    echo "Branch: ${cyan}$branch${reset}"
    echo "Started: ${green}$started${reset}"
    echo "Attempts: ${yellow}$attempts${reset}"
    echo "Staged files: ${blue}$files${reset}"
    echo ""

    echo "Issues by hook (last attempt):"
    jq -r '.attempts[-1].hooks | to_entries[] | select(.value.issues_before_fix > 0 or .value.errors > 0 or .value.issues > 0) | "  \(.key): \(.value.issues_before_fix // .value.errors // .value.issues // 0)"' "$session_file" 2>/dev/null
  else
    echo "No active session for branch ${cyan}$branch${reset}"
    echo "Start a commit attempt to begin tracking."
  fi
}

function journey-history() {
  cd "$ICHRISBIRCH_HOME" || exit
  local count="${1:-10}"
  echo "ðŸš€ Recent Journey History (last $count commits):"
  echo ""

  local sessions_dir="$ICHRISBIRCH_HOME/stats/sessions"
  if [ -d "$sessions_dir" ]; then
    find "$sessions_dir" -maxdepth 1 -name "session_*.json" -type f -print0 2>/dev/null | xargs -0 ls -t | head -n "$count" | while read -r file; do
      if [ -f "$file" ]; then
        local commit
        commit=$(jq -r '.commit.short' "$file" 2>/dev/null)
        local date
        date=$(jq -r '.commit.date' "$file" 2>/dev/null | cut -d'T' -f1)
        local message
        message=$(jq -r '.commit.message' "$file" 2>/dev/null | head -c 35)
        local attempts
        attempts=$(jq -r '.journey.total_attempts' "$file" 2>/dev/null)
        local duration
        duration=$(jq -r '.journey.total_duration_seconds' "$file" 2>/dev/null)
        local files_count
        files_count=$(jq '.staged_files | length' "$file" 2>/dev/null)

        # Format duration nicely
        local duration_fmt
        if [ "$duration" != "null" ] && [ -n "$duration" ]; then
          duration_fmt=$(printf "%.0f" "$duration")
          if [ "$duration_fmt" -gt 60 ]; then
            duration_fmt="$((duration_fmt / 60))m$((duration_fmt % 60))s"
          else
            duration_fmt="${duration_fmt}s"
          fi
        else
          duration_fmt="--"
        fi

        printf "${cyan}%s${reset} %s  ${yellow}%s${reset} attempts  ${green}%s${reset}  ${blue}%s${reset} files  %s\n" \
          "$commit" "$date" "$attempts" "$duration_fmt" "$files_count" "$message"
      fi
    done
  else
    echo "No sessions directory found. Complete a commit to start tracking journeys."
  fi
}

function journey-detail() {
  cd "$ICHRISBIRCH_HOME" || exit
  local commit="${1:-}"

  if [ -z "$commit" ]; then
    echo "Usage: ichrisbirch journey detail <commit-hash>"
    return 1
  fi

  local sessions_dir="$ICHRISBIRCH_HOME/stats/sessions"
  local session_file
  session_file=$(find "$sessions_dir" -maxdepth 1 -name "session_*${commit}*.json" -type f 2>/dev/null | head -1)

  if [ -z "$session_file" ] || [ ! -f "$session_file" ]; then
    echo "No session found for commit ${cyan}$commit${reset}"
    return 1
  fi

  echo "ðŸš€ Journey Details for ${cyan}$commit${reset}"
  echo ""

  # Commit info
  echo "${green}Commit:${reset}"
  jq -r '"  Hash: \(.commit.hash)\n  Message: \(.commit.message)\n  Date: \(.commit.date)\n  Branch: \(.commit.branch)"' "$session_file"
  echo ""

  # Journey summary
  echo "${green}Journey:${reset}"
  jq -r '"  Duration: \(.journey.total_duration_seconds)s\n  Attempts: \(.journey.total_attempts)\n  Hooks that blocked: \(.journey.hooks_that_blocked | join(", "))"' "$session_file"
  echo ""

  # Files changed
  echo "${green}Files ($(jq '.staged_files | length' "$session_file")):${reset}"
  jq -r '.files | to_entries[] | "  \(.value.status): \(.key) (+\(.value.lines_added)/-\(.value.lines_removed))"' "$session_file"
  echo ""

  # Errors fixed
  echo "${green}Total errors fixed:${reset}"
  jq -r '.journey.total_errors_fixed | to_entries[] | "  \(.key): \(.value)"' "$session_file"
}

function usage() {
  echo "${yellow}           _                  _                  _       ${reset}"
  echo "${yellow}  (*)     |=|         (*)    |=|   (*)          |=|      ${reset}"
  echo "${yellow}   _  ____|=| _   ____ _  ___|=| _  _  ____ ____|=| _    ${reset}"
  echo "${yellow}  |=|/ ___)=|| =\/ ___)=|/___)=|| \|=|/ ___) ___)=|| =\  ${reset}"
  echo "${yellow}  |=(=(___|=| |=|=|   |=|___ |=|_)=)=|=|  (=(___|=| |=|  ${reset}"
  echo "${yellow}  |_|\____)_| |_|_|   |_(___/|____/|_|_|   \____)_| |_|  ${reset}"
  echo
  echo "${green}Core Commands:${reset}"
  echo "  ${blue}open${reset}      - Launch VS Code and create tmux session for development"
  echo "  ${blue}cd${reset}        - Navigate to project directory and activate Python virtual environment"
  echo "  ${blue}logs${reset}      - List log files in configured log directory"
  echo "  ${blue}test run${reset}  - Execute pytest (supports paths and args, see below)"
  echo "  ${blue}ssl-manager <action> [env]${reset} - Manage SSL certificates for HTTPS"
  echo "    â€¢ ${yellow}Actions${reset}: generate, validate, info"
  echo "    â€¢ ${yellow}Environments${reset}: dev, test, prod, all"
  echo "    â€¢ ${yellow}Examples${reset}: ${cyan}ssl-manager generate dev${reset}, ${cyan}ssl-manager info all${reset}"
  echo
  echo "${green}Development Environment (HTTPS with Traefik):${reset}"
  echo "  ${blue}dev start${reset}     - Start development services with HTTPS (api.docker.localhost, app.docker.localhost, etc.)"
  echo "  ${blue}dev stop${reset}      - Stop all development services and remove containers"
  echo "  ${blue}dev restart${reset}   - Restart existing containers without rebuilding images (quick recovery from crashes)"
  echo "  ${blue}dev rebuild${reset}   - Stop services, rebuild Docker images, and restart (use after code/dependency changes)"
  echo "  ${blue}dev logs${reset}      - View live Docker container logs"
  echo "  ${blue}dev status${reset}    - Display container status and service URLs"
  echo "  ${blue}dev health${reset}    - Run comprehensive health checks for all services"
  echo
  echo "${green}Test Environment (HTTPS with Traefik - runs alongside dev):${reset}"
  echo "  ${blue}testing start${reset}   - Start isolated test services with HTTPS (api.test.localhost:8443, etc.)"
  echo "  ${blue}testing stop${reset}    - Stop test environment services"
  echo "  ${blue}testing restart${reset} - Restart test containers without rebuilding"
  echo "  ${blue}testing rebuild${reset} - Rebuild and restart test environment"
  echo "  ${blue}testing logs${reset}    - View live test container logs (Docker Compose output)"
  echo "  ${blue}testing status${reset}  - Display test container status and service URLs"
  echo "  ${blue}testing health${reset}  - Run comprehensive health checks for test services"
  echo "  ${blue}testing app-logs [lines] [--follow]${reset} - View consolidated application logs from testing.log"
  echo "    â€¢ ${yellow}lines${reset}: number of lines to show (default: 100)"
  echo "    â€¢ ${yellow}--follow${reset}: follow logs in real-time"
  echo "    â€¢ Examples: ${cyan}testing app-logs${reset}, ${cyan}testing app-logs 50${reset}, ${cyan}testing app-logs --follow${reset}"
  echo "  ${blue}testing app-logs-follow${reset} - Follow consolidated application logs in real-time"
  echo "  ${blue}test run [path] [args]${reset} - Execute pytest with test environment"
  echo "    â€¢ No args: run all tests"
  echo "    â€¢ With path: run specific test file or directory"
  echo "    â€¢ Examples: ${cyan}test run${reset}, ${cyan}test run tests/ichrisbirch/app/test_login.py -v${reset}"
  echo "  ${blue}test cov [path] [args]${reset} - Run pytest with coverage report"
  echo "    â€¢ Generates HTML coverage report in htmlcov/"
  echo
  echo "${green}Production Environment (HTTPS with Traefik):${reset}"
  echo "  ${blue}prod start${reset}     - Start production services with HTTPS (yourdomain.local)"
  echo "  ${blue}prod stop${reset}      - Stop production services and remove containers"
  echo "  ${blue}prod restart${reset}   - Restart existing production containers without rebuilding"
  echo "  ${blue}prod rebuild${reset}   - Stop services, rebuild Docker images, and restart production"
  echo "  ${blue}prod logs${reset}      - View production Docker container logs"
  echo "  ${blue}prod status${reset}    - Check production service status and URLs"
  echo "  ${blue}prod health${reset}    - Run comprehensive health checks for production services"
  echo "  ${blue}prod apihealth${reset} - HTTP health check against production API endpoint"
  echo "  ${blue}prod reboot-ec2${reset} - Restart EC2 instance via AWS CLI (default: ichrisbirch-webserver)"
  echo
  echo "${green}Project Stats (synced with S3):${reset}"
  echo "  ${blue}stats${reset}         - Show current project stats (alias: stats show)"
  echo "  ${blue}stats show${reset}    - Display current project stats without saving"
  echo "  ${blue}stats collect${reset} - Collect and save stats for current commit"
  echo "  ${blue}stats sync${reset}    - Sync stats with S3 (pull then push)"
  echo "  ${blue}stats sync push${reset}  - Push local stats to S3"
  echo "  ${blue}stats sync pull${reset}  - Pull stats from S3 to local"
  echo "  ${blue}stats history [n]${reset} - Show stats history for last n commits (default: 10)"
  echo ""
  echo "${green}Developer Journey (commit session tracking):${reset}"
  echo "  ${blue}journey${reset}           - Show current commit session (alias: journey current)"
  echo "  ${blue}journey current${reset}   - Show active session for current branch"
  echo "  ${blue}journey history [n]${reset} - Show journey history for last n commits (default: 10)"
  echo "  ${blue}journey detail <commit>${reset} - Show detailed journey for a specific commit"
  echo
  echo "${green}ðŸ“± Service URLs (All environments use HTTPS):${reset}"
  echo "  ${blue}Development${reset}: api.docker.localhost, app.docker.localhost, chat.docker.localhost"
  echo "  ${blue}Test${reset}: api.test.localhost:8443, app.test.localhost:8443, chat.test.localhost:8443"
  echo "  ${blue}Production${reset}: api.yourdomain.local, app.yourdomain.local, chat.yourdomain.local"
  echo
  echo "${green}Technical Notes:${reset}"
  echo "  â€¢ All environments use modern Traefik reverse proxy with HTTPS and WebSocket support"
  echo "  â€¢ Development and test environments run simultaneously on different ports"
  echo "  â€¢ SSL certificates managed automatically via ${blue}ssl-manager${reset} command"
  echo "  â€¢ Use ${blue}<env> health${reset} commands for comprehensive service validation"
  echo "  â€¢ Legacy HTTP access available on original ports (5000, 8000, 8505) alongside HTTPS"
}
# check if the first argument is empty and print usage if so
if [ -z "$1" ]; then
  usage
  exit 0
fi

case $1 in
help | -h | --help | -help)
  usage
  ;;
install)
  install
  ;;
open)
  open
  ;;
cd)
  project-cd
  ;;
logs)
  logs
  ;;
test)
  # Pass remaining arguments to test function (e.g., test run path/to/test.py -v)
  subcmd="$2"
  shift 2  # Remove 'ichrisbirch' and 'test' (note: $1 is 'test', $2 is subcommand)
  test-"$subcmd" "$@"
  ;;
testing)
  case "$2" in
  app-logs)
    # Handle app-logs with lines and --follow options
    testing-app-logs "$3" "$4"
    ;;
  app-logs-follow)
    # Simplified follow function
    testing-app-logs-follow
    ;;
  health)
    testing-health
    ;;
  *)
    # Default testing command pattern
    testing-"$2"
    ;;
  esac
  ;;
dev)
  case "$2" in
  health)
    dev-health
    ;;
  *)
    dev-"$2"
    ;;
  esac
  ;;
prod)
  case "$2" in
  health)
    prod-health
    ;;
  *)
    prod-"$2"
    ;;
  esac
  ;;
ssl-manager)
  ssl-manager "$2" "$3"
  ;;
stats)
  case "$2" in
  show | "")
    stats-show
    ;;
  collect)
    stats-collect
    ;;
  sync)
    stats-sync "$3"
    ;;
  history)
    stats-history "$3"
    ;;
  *)
    echo "${red}Unknown stats command: $2${reset}"
    echo "Usage: ichrisbirch stats [show|collect|sync|history]"
    ;;
  esac
  ;;
journey)
  case "$2" in
  current | "")
    journey-current
    ;;
  history)
    journey-history "$3"
    ;;
  detail)
    journey-detail "$3"
    ;;
  *)
    echo "${red}Unknown journey command: $2${reset}"
    echo "Usage: ichrisbirch journey [current|history|detail]"
    ;;
  esac
  ;;
*)
  echo "${red}!! '$1' is not a valid ichrisbirch command !!${reset}"
  echo ""
  usage
  ;;
esac
