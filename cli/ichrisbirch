#!/usr/bin/env bash
# shellcheck shell=bash
# shellcheck disable=SC2034

ICHRISBIRCH_HOME="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# URLs for each environment
DEV_API_URL="https://api.docker.localhost"
DEV_APP_URL="https://app.docker.localhost"
DEV_CHAT_URL="https://chat.docker.localhost"
DEV_DASHBOARD_URL="https://dashboard.docker.localhost"
DEV_API_PORT="http://localhost:8000"
DEV_APP_PORT="http://localhost:5000"
DEV_CHAT_PORT="http://localhost:8505"

TEST_API_URL="https://api.test.localhost:8443"
TEST_APP_URL="https://app.test.localhost:8443"
TEST_CHAT_URL="https://chat.test.localhost:8443"
TEST_DASHBOARD_URL="https://dashboard.test.localhost:8443"
TEST_API_PORT="http://localhost:8001"
TEST_APP_PORT="http://localhost:5001"
TEST_CHAT_PORT="http://localhost:8507"

PROD_DOMAIN="${DOMAIN:-ichrisbirch.com}"
PROD_API_URL="https://api.${PROD_DOMAIN}"
PROD_APP_URL="https://${PROD_DOMAIN}"
PROD_CHAT_URL="https://chat.${PROD_DOMAIN}"

# Docker compose commands
COMPOSE_DEV="docker compose --project-name ichrisbirch-dev -f docker-compose.yml -f docker-compose.dev.yml"
COMPOSE_TEST="docker compose --project-name ichrisbirch-test -f docker-compose.yml -f docker-compose.test.yml"
COMPOSE_PROD="docker compose --project-name ichrisbirch-prod -f docker-compose.yml"

# Script paths
HEALTH_CHECK_SCRIPT="$ICHRISBIRCH_HOME/cli/health-check.sh"
SSL_MANAGER_SCRIPT="$ICHRISBIRCH_HOME/deploy-containers/traefik/scripts/ssl-manager.sh"

# Colors
red=$(tput setaf 1)
green=$(tput setaf 2)
yellow=$(tput setaf 3)
blue=$(tput setaf 4)
magenta=$(tput setaf 5)
cyan=$(tput setaf 6)
white=$(tput setaf 7)
gray=$(tput setaf 8)
bright_red=$(tput setaf 9)
bright_green=$(tput setaf 10)
bright_yellow=$(tput setaf 11)
bright_blue=$(tput setaf 12)
bright_magenta=$(tput setaf 13)
bright_cyan=$(tput setaf 14)
orange=$(tput setaf 208)
reset=$(tput sgr0)

# Source stats commands
# shellcheck source=cli/stats
source "$ICHRISBIRCH_HOME/cli/stats"

function colored-logs() {
  local RED_REDIS="${red}redis${reset}"
  local GREEN_POSTGRES="${green}postgres${reset}"
  local BRIGHT_GREEN_API="${bright_green}api${reset}"
  local BRIGHT_BLUE_APP="${bright_blue}app${reset}"
  local ORANGE_CHAT="${orange}chat${reset}"
  local YELLOW_SCHEDULER="${yellow}scheduler${reset}"
  local CYAN_TRAEFIK="${cyan}traefik${reset}"

  sed \
    -e 's/ichrisbirch-//g' \
    -e 's/-dev//g' \
    -e 's/-testing//g' \
    -e 's/-test//g' \
    -e 's/^api[ ]*|/'"${BRIGHT_GREEN_API}"' |/' \
    -e 's/^app[ ]*|/'"${BRIGHT_BLUE_APP}"' |/' \
    -e 's/^redis[ ]*|/'"${RED_REDIS}"' |/' \
    -e 's/^postgres[ ]*|/'"${GREEN_POSTGRES}"' |/' \
    -e 's/^chat[ ]*|/'"${ORANGE_CHAT}"' |/' \
    -e 's/^scheduler[ ]*|/'"${YELLOW_SCHEDULER}"' |/' \
    -e 's/^traefik[ ]*|/'"${CYAN_TRAEFIK}"' |/'
}

function colored-status() {
  local GREEN_RUNNING="${green}running${reset}"
  local RED_EXITED="${red}exited${reset}"
  local YELLOW_RESTARTING="${yellow}restarting${reset}"
  local BLUE_PAUSED="${blue}paused${reset}"
  local MAGENTA_DEAD="${magenta}dead${reset}"
  local CYAN_CREATED="${cyan}created${reset}"
  local YELLOW_UNHEALTHY="${yellow}unhealthy${reset}"
  local GREEN_HEALTHY="${green}healthy${reset}"

  awk -v running="$GREEN_RUNNING" \
    -v exited="$RED_EXITED" \
    -v restarting="$YELLOW_RESTARTING" \
    -v paused="$BLUE_PAUSED" \
    -v dead="$MAGENTA_DEAD" \
    -v created="$CYAN_CREATED" \
    -v unhealthy="$YELLOW_UNHEALTHY" \
    -v healthy="$GREEN_HEALTHY" '
    {
        gsub(/ichrisbirch-/, "");
        gsub(/running/, running);
        gsub(/exited/, exited);
        gsub(/restarting/, restarting);
        gsub(/paused/, paused);
        gsub(/dead/, dead);
        gsub(/created/, created);
        gsub(/unhealthy/, unhealthy);
        gsub(/healthy/, healthy);
        print $0;
    }'
}

function ensure-proxy-network() {
  if ! docker network inspect proxy >/dev/null 2>&1; then
    echo "Creating external proxy network..."
    docker network create proxy
  fi
}

function install() {
  ln -sf "$ICHRISBIRCH_HOME/cli/ichrisbirch" "$HOME/.local/bin/icb"
}

function ssl-manager() {
  local action="${1:-info}"
  local environment="${2:-all}"
  cd "$ICHRISBIRCH_HOME" || exit

  if [ -x "$SSL_MANAGER_SCRIPT" ]; then
    "$SSL_MANAGER_SCRIPT" "$action" "$environment"
  else
    echo "${red}SSL manager script not found: $SSL_MANAGER_SCRIPT${reset}"
    return 1
  fi
}

# Development environment
function dev-start() {
  cd "$ICHRISBIRCH_HOME" || exit
  ensure-proxy-network

  echo "Starting ${blue}DEV${reset} environment"
  $COMPOSE_DEV up -d

  echo ""
  echo "Development environment started:"
  echo "  ${green}API${reset}:       ${cyan}${DEV_API_URL}${reset}"
  echo "  ${green}APP${reset}:       ${cyan}${DEV_APP_URL}${reset}"
  echo "  ${green}CHAT${reset}:      ${cyan}${DEV_CHAT_URL}${reset}"
  echo "  ${green}DASHBOARD${reset}: ${cyan}${DEV_DASHBOARD_URL}${reset} (user: dev, pass: devpass)"
  echo ""
  echo "Direct ports (bypass Traefik):"
  echo "  ${green}API${reset}:  ${cyan}${DEV_API_PORT}${reset}"
  echo "  ${green}APP${reset}:  ${cyan}${DEV_APP_PORT}${reset}"
  echo "  ${green}CHAT${reset}: ${cyan}${DEV_CHAT_PORT}${reset}"
  echo "  ${green}PostgreSQL${reset}: ${cyan}localhost:5432${reset}"
  echo "  ${green}Redis${reset}: ${cyan}localhost:6379${reset}"
}

function dev-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Stopping ${blue}DEV${reset} environment"
  $COMPOSE_DEV down
}

function dev-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Restarting ${blue}DEV${reset} environment"
  $COMPOSE_DEV up -d
}

function dev-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Rebuilding ${blue}DEV${reset} environment"
  $COMPOSE_DEV down
  $COMPOSE_DEV up -d --build
}

function dev-logs() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Viewing ${blue}DEV${reset} logs (Ctrl+C to exit)"
  echo ""

  while true; do
    $COMPOSE_DEV logs --follow --tail=50 "$@" 2>/dev/null | colored-logs
    sleep 2
  done
}

function dev-status() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "${blue}DEV${reset} environment status:"
  echo ""
  $COMPOSE_DEV ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status
  echo ""
  echo "${blue}URLs${reset}: $DEV_API_URL | $DEV_APP_URL | $DEV_CHAT_URL"
}

function dev-health() {
  echo "Running health check for ${blue}DEV${reset} environment"
  cd "$ICHRISBIRCH_HOME" || exit
  "$HEALTH_CHECK_SCRIPT" dev
}

# Test environment
function test-run() {
  cd "$ICHRISBIRCH_HOME" || exit
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"
  export ENVIRONMENT=testing

  # Check if containers are already running and healthy
  local containers_ready=false
  if $COMPOSE_TEST ps --status running -q 2>/dev/null | grep -q .; then
    echo "${blue}Test containers already running, checking health...${reset}"
    if $COMPOSE_TEST ps | grep -q "healthy"; then
      containers_ready=true
      echo "${green}Containers healthy, reusing them${reset}"
    else
      echo "${yellow}Containers unhealthy, restarting...${reset}"
      $COMPOSE_TEST down --volumes 2>/dev/null || true
    fi
  fi

  if [ "$containers_ready" = false ]; then
    ensure-proxy-network
    echo "${blue}Starting test containers...${reset}"
    $COMPOSE_TEST up -d
    echo "Waiting for services to be ready..."
    sleep 15
  fi

  # Always reset database to ensure clean state
  echo "${blue}Initializing test database...${reset}"
  if ! ENVIRONMENT=testing uv run python -m ichrisbirch.database.initialization --env testing --db-host localhost --db-port 5434; then
    echo "${red}Database initialization failed${reset}"
    return 1
  fi

  # Run pytest
  echo ""
  echo "${green}Running tests...${reset}"
  echo ""
  local test_exit_code=0
  if [ $# -eq 0 ]; then
    uv run pytest || test_exit_code=$?
  else
    uv run pytest "$@" || test_exit_code=$?
  fi

  # Always leave containers running for fast iteration
  echo ""
  echo "${cyan}Containers left running for fast iteration.${reset}"
  echo "Stop them with: ${blue}icb testing stop${reset}"

  return $test_exit_code
}

function testing-start() {
  cd "$ICHRISBIRCH_HOME" || exit
  ensure-proxy-network

  echo "Starting ${blue}TESTING${reset} environment"
  $COMPOSE_TEST up -d

  echo "Waiting for services to be ready..."
  sleep 15

  echo "Initializing test database..."
  # shellcheck disable=1091
  source "$ICHRISBIRCH_HOME/.venv/bin/activate"

  if ENVIRONMENT=testing uv run python -m ichrisbirch.database.initialization --env testing --db-host localhost --db-port 5434; then
    echo "${green}Database initialized successfully${reset}"
  else
    echo "${red}Database initialization failed${reset}"
    return 1
  fi

  echo ""
  echo "Testing environment started:"
  echo "  ${green}API${reset}:       ${cyan}${TEST_API_URL}${reset}"
  echo "  ${green}APP${reset}:       ${cyan}${TEST_APP_URL}${reset}"
  echo "  ${green}CHAT${reset}:      ${cyan}${TEST_CHAT_URL}${reset}"
  echo "  ${green}DASHBOARD${reset}: ${cyan}${TEST_DASHBOARD_URL}${reset} (user: test, pass: testpass)"
  echo ""
  echo "Direct ports (bypass Traefik):"
  echo "  ${green}API${reset}:  ${cyan}${TEST_API_PORT}${reset}"
  echo "  ${green}APP${reset}:  ${cyan}${TEST_APP_PORT}${reset}"
  echo "  ${green}CHAT${reset}: ${cyan}${TEST_CHAT_PORT}${reset}"
  echo "  ${green}PostgreSQL${reset}: ${cyan}localhost:5434${reset}"
  echo "  ${green}Redis${reset}: ${cyan}localhost:6380${reset}"
}

function testing-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Stopping ${blue}TESTING${reset} environment"
  $COMPOSE_TEST down --volumes
}

function testing-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Restarting ${blue}TESTING${reset} environment"
  $COMPOSE_TEST up -d
}

function testing-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Rebuilding ${blue}TESTING${reset} environment"
  $COMPOSE_TEST down
  $COMPOSE_TEST up -d --build
}

function testing-logs() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Viewing ${blue}TESTING${reset} logs (Ctrl+C to exit)"
  echo ""

  while true; do
    $COMPOSE_TEST logs --follow --tail=50 "$@" 2>/dev/null | colored-logs
    sleep 2
  done
}

function testing-status() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "${blue}TESTING${reset} environment status:"
  echo ""
  $COMPOSE_TEST ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status
  echo ""
  echo "${blue}URLs${reset}: $TEST_API_URL | $TEST_APP_URL | $TEST_CHAT_URL"
}

function testing-health() {
  echo "Running health check for ${blue}TESTING${reset} environment"
  cd "$ICHRISBIRCH_HOME" || exit
  "$HEALTH_CHECK_SCRIPT" test
}

# Production environment
function load-prod-env() {
  local aws_region="${AWS_REGION:-us-east-2}"

  get_ssm_param() {
    aws ssm get-parameter \
      --region "$aws_region" \
      --name "/ichrisbirch/production/$1" \
      --with-decryption \
      --query 'Parameter.Value' \
      --output text
  }

  export POSTGRES_PASSWORD
  POSTGRES_PASSWORD=$(get_ssm_param "postgres/password") || {
    echo "${red}Failed to fetch POSTGRES_PASSWORD from SSM${reset}"
    return 1
  }

  export REDIS_PASSWORD
  REDIS_PASSWORD=$(get_ssm_param "redis/password") || {
    echo "${red}Failed to fetch REDIS_PASSWORD from SSM${reset}"
    return 1
  }

  export DOMAIN="${DOMAIN:-ichrisbirch.com}"
}

function prod-start() {
  cd "$ICHRISBIRCH_HOME" || exit

  echo "Fetching secrets from AWS SSM..."
  load-prod-env || return 1
  echo "Secrets loaded for ${magenta}production${reset}"

  ensure-proxy-network

  echo "Starting ${magenta}PRODUCTION${reset} environment"
  $COMPOSE_PROD up -d

  echo ""
  echo "Production environment started:"
  echo "  ${green}APP${reset}:  ${cyan}${PROD_APP_URL}${reset}"
  echo "  ${green}API${reset}:  ${cyan}${PROD_API_URL}${reset}"
  echo "  ${green}CHAT${reset}: ${cyan}${PROD_CHAT_URL}${reset}"
}

function prod-stop() {
  cd "$ICHRISBIRCH_HOME" || exit
  load-prod-env || return 1
  echo "Stopping ${magenta}PRODUCTION${reset} environment"
  $COMPOSE_PROD down
}

function prod-restart() {
  cd "$ICHRISBIRCH_HOME" || exit
  load-prod-env || return 1
  echo "Restarting ${magenta}PRODUCTION${reset} environment"
  $COMPOSE_PROD up -d
}

function prod-rebuild() {
  cd "$ICHRISBIRCH_HOME" || exit
  echo "Fetching secrets from AWS SSM..."
  load-prod-env || return 1
  echo "Rebuilding ${magenta}PRODUCTION${reset} environment"
  $COMPOSE_PROD down
  $COMPOSE_PROD up -d --build
}

function prod-logs() {
  cd "$ICHRISBIRCH_HOME" || exit
  load-prod-env || return 1
  echo "Viewing ${magenta}PRODUCTION${reset} logs (Ctrl+C to exit)"
  echo ""

  while true; do
    $COMPOSE_PROD logs --follow --tail=50 "$@" 2>/dev/null | colored-logs
    sleep 2
  done
}

function prod-status() {
  cd "$ICHRISBIRCH_HOME" || exit
  load-prod-env || return 1
  echo "${magenta}PRODUCTION${reset} environment status:"
  echo ""
  $COMPOSE_PROD ps --format "table {{.Service}}\t{{.State}}\t{{.Ports}}" | colored-status
  echo ""
  echo "${magenta}URLs${reset}: $PROD_APP_URL | $PROD_API_URL | $PROD_CHAT_URL"
}

function prod-health() {
  echo "Running health check for ${magenta}PRODUCTION${reset} environment"
  cd "$ICHRISBIRCH_HOME" || exit
  "$HEALTH_CHECK_SCRIPT" prod
}

function prod-apihealth() {
  curl --silent "$PROD_API_URL/health/" | jq
}

function usage() {
  echo "${yellow}           _                  _                  _       ${reset}"
  echo "${yellow}  (*)     |=|         (*)    |=|   (*)          |=|      ${reset}"
  echo "${yellow}   _  ____|=| _   ____ _  ___|=| _  _  ____ ____|=| _    ${reset}"
  echo "${yellow}  |=|/ ___)=|| =\/ ___)=|/___)=|| \|=|/ ___) ___)=|| =\  ${reset}"
  echo "${yellow}  |=(=(___|=| |=|=|   |=|___ |=|_)=)=|=|  (=(___|=| |=|  ${reset}"
  echo "${yellow}  |_|\____)_| |_|_|   |_(___/|____/|_|_|   \____)_| |_|  ${reset}"
  echo
  echo "${green}Core Commands:${reset}"
  echo "  ${blue}test run${reset}  - Run tests (containers reused for speed)"
  echo "  ${blue}ssl-manager <action> [env]${reset} - Manage SSL certificates"
  echo
  echo "${green}Development:${reset}"
  echo "  ${blue}dev start|stop|restart|rebuild${reset} - Manage dev environment"
  echo "  ${blue}dev logs [service]${reset} - View logs (persists across restarts)"
  echo "  ${blue}dev status|health${reset} - Check environment"
  echo
  echo "${green}Testing:${reset}"
  echo "  ${blue}testing start|stop|restart|rebuild${reset} - Manage test environment"
  echo "  ${blue}testing logs [service]${reset} - View logs"
  echo "  ${blue}testing status|health${reset} - Check environment"
  echo "  ${blue}test run [path] [args]${reset} - Run pytest (fast iteration)"
  echo "  ${blue}test cov${reset} - Run with coverage"
  echo
  echo "${green}Production:${reset}"
  echo "  ${blue}prod start|stop|restart|rebuild${reset} - Manage production"
  echo "  ${blue}prod logs [service]${reset} - View logs"
  echo "  ${blue}prod status|health|apihealth${reset} - Check environment"
  echo
  echo "${green}Stats:${reset}"
  echo "  ${blue}stats${reset} - Show stats submenu"
  echo "  ${blue}stats summary${reset} - Dashboard overview"
  echo
  echo "${green}URLs:${reset}"
  echo "  ${blue}Dev${reset}:  $DEV_API_URL | $DEV_APP_URL"
  echo "  ${blue}Test${reset}: $TEST_API_URL | $TEST_APP_URL"
  echo "  ${blue}Prod${reset}: $PROD_API_URL | $PROD_APP_URL"
}

if [ -z "$1" ]; then
  usage
  exit 0
fi

case $1 in
help | -h | --help)
  usage
  ;;
install)
  install
  ;;
cd)
  cd "$ICHRISBIRCH_HOME" || exit
  # shellcheck source=/dev/null
  [ -d ".venv" ] && source .venv/bin/activate
  exec "$SHELL"
  ;;
test)
  subcmd="$2"
  shift 2
  test-"$subcmd" "$@"
  ;;
testing)
  case "$2" in
  health) testing-health ;;
  logs)
    shift 2
    testing-logs "$@"
    ;;
  *) testing-"$2" ;;
  esac
  ;;
dev)
  case "$2" in
  health) dev-health ;;
  logs)
    shift 2
    dev-logs "$@"
    ;;
  *) dev-"$2" ;;
  esac
  ;;
prod)
  case "$2" in
  health) prod-health ;;
  logs)
    shift 2
    prod-logs "$@"
    ;;
  *) prod-"$2" ;;
  esac
  ;;
ssl-manager)
  ssl-manager "$2" "$3"
  ;;
stats)
  case "$2" in
  "") stats-usage ;;
  summary) stats-summary ;;
  code) stats-code ;;
  tests) stats-tests ;;
  quality) stats-quality ;;
  activity) stats-activity "$3" ;;
  events) stats-events "$3" ;;
  trends) stats-trends ;;
  churn) stats-churn "$3" ;;
  snapshot) stats-snapshot ;;
  *)
    echo "${red}Unknown stats command: $2${reset}"
    stats-usage
    ;;
  esac
  ;;
*)
  echo "${red}Unknown command: $1${reset}"
  echo ""
  usage
  ;;
esac
