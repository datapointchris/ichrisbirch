services:
  # Traefik service for test environment
  # Note: v3.6+ required for Docker 29+ API compatibility (auto-negotiation)
  traefik:
    image: traefik:v3.6
    container_name: ichrisbirch-traefik-test
    command:
      - "--ping=true"
      - "--api.dashboard=true"
      - "--api.debug=true"
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=proxy"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.http.tls.domains[0].main=*.test.localhost"
      - "--certificatesresolvers.myresolver.acme.email=test@example.com"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
    ports: !override
      - "9080:80"    # HTTP redirect to HTTPS
      - "8443:443"   # HTTPS traffic
      - "9082:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./deploy-containers/traefik/dynamic/test:/etc/traefik/dynamic:ro
      - ./deploy-containers/traefik/certs:/etc/ssl/certs:ro
      - traefik_test_letsencrypt:/letsencrypt
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      # Dashboard route
      - "traefik.http.routers.dashboard-test.rule=Host(`dashboard.test.localhost`)"
      - "traefik.http.routers.dashboard-test.entrypoints=websecure"
      - "traefik.http.routers.dashboard-test.tls=true"
      - "traefik.http.routers.dashboard-test.tls.options=test@file"
      - "traefik.http.routers.dashboard-test.service=api@internal"
      - "traefik.http.routers.dashboard-test.middlewares=dashboard-auth-test@file"
    environment:
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_API_DEBUG=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "traefik-test"

  # Test database - optimized for speed over durability
  postgres:
    image: postgres:16-alpine
    container_name: ichrisbirch-postgres-testing
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_DB=ichrisbirch
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - PGDATA=/tmp/postgres
    # Use tmpfs for faster test database (in-memory storage)
    tmpfs:
      - /tmp/postgres
    # Test optimizations: disable durability for maximum speed
    command: >
      postgres
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c max_connections=100
      -c shared_buffers=128MB
      -c max_wal_size=2GB
      -c checkpoint_completion_target=0.9
      -c log_destination=stderr
      -c logging_collector=off
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ichrisbirch"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "postgres-test"

  # Test Redis - optimized for speed, no persistence
  redis:
    image: redis:7-alpine
    container_name: ichrisbirch-redis-testing
    ports:
      - "6380:6379"
    # Test optimizations: no persistence, minimal configuration
    command: >
      redis-server
      --save ""
      --appendonly no
      --loglevel warning
    environment: [] # Override production environment
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "redis-test"
  api:
    build:
      context: .
      target: testing
    container_name: ichrisbirch-api-testing
    # Run without reload for consistent test environment
    command: >
      uv run uvicorn ichrisbirch.wsgi_api:api
      --host 0.0.0.0
      --port 8000
      --log-level debug
      --no-access-log
    ports:
      - "8001:8000" # Map to different external port to avoid conflicts
    environment:
      - ENVIRONMENT=testing
      - FASTAPI_TESTING=True
      - LOG_FORMAT=${LOG_FORMAT:-console}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - LOG_COLORS=${LOG_COLORS:-true}
      # AWS credentials for SSM parameter access (optional for local development)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - AWS_REGION=${AWS_REGION:-us-east-2}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
    volumes:
      - type: bind
        source: .
        target: /app
      - type: volume
        source: venv_shared
        target: /app/.venv
      - type: bind
        source: ~/.aws
        target: /root/.aws
        read_only: true
      - type: volume
        source: uv_cache
        target: /root/.cache/uv
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      # API routes
      - "traefik.http.routers.api-test.rule=Host(`api.test.localhost`)"
      - "traefik.http.routers.api-test.entrypoints=websecure"
      - "traefik.http.routers.api-test.tls=true"
      - "traefik.http.routers.api-test.tls.options=test@file"
      - "traefik.http.routers.api-test.service=api-test"
      - "traefik.http.routers.api-test.middlewares=cors-test@file,security-headers-test@file,rate-limit-test@file"
      - "traefik.http.services.api-test.loadbalancer.server.port=8000"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 10s
      start_period: 60s  # Give more time for venv setup in CI
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "api-test"

  # Test Flask app
  app:
    build:
      context: .
      target: testing
    container_name: ichrisbirch-app-testing
    # Run without reload for consistent test environment
    command: >
      uv run flask
      --app ichrisbirch.wsgi_app:app run
      --host 0.0.0.0
      --port 5000
    ports:
      - "5001:5000" # Map to different external port to avoid conflicts
    environment:
      - ENVIRONMENT=testing
      - FLASK_TESTING=True
      - LOG_FORMAT=${LOG_FORMAT:-console}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - LOG_COLORS=${LOG_COLORS:-true}
      # AWS credentials for SSM parameter access (optional for local development)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - AWS_REGION=${AWS_REGION:-us-east-2}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
    volumes:
      - type: bind
        source: .
        target: /app
      - type: volume
        source: venv_shared
        target: /app/.venv
      - type: bind
        source: ~/.aws
        target: /root/.aws
        read_only: true
      - type: volume
        source: uv_cache
        target: /root/.cache/uv
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      # App routes
      - "traefik.http.routers.app-test.rule=Host(`app.test.localhost`)"
      - "traefik.http.routers.app-test.entrypoints=websecure"
      - "traefik.http.routers.app-test.tls=true"
      - "traefik.http.routers.app-test.tls.options=test@file"
      - "traefik.http.routers.app-test.service=app-test"
      - "traefik.http.routers.app-test.middlewares=cors-test@file,security-headers-test@file,rate-limit-test@file"
      - "traefik.http.services.app-test.loadbalancer.server.port=5000"
    restart: unless-stopped
    depends_on:
      api:
        condition: service_started  # Wait for API to initialize shared venv first
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "app-test"

  # Test chat service - needed for API tests
  chat:
    build:
      context: .
      target: testing
    container_name: ichrisbirch-chat-testing
    command: >
      uv run streamlit run ichrisbirch/chat/app.py
      --server.address=0.0.0.0
      --server.port=8505
      --server.headless=true
    environment:
      - ENVIRONMENT=testing
      - LOG_FORMAT=${LOG_FORMAT:-console}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - LOG_COLORS=${LOG_COLORS:-true}
      # AWS credentials for SSM parameter access (optional for local development)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - AWS_REGION=${AWS_REGION:-us-east-2}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
    volumes:
      - type: bind
        source: .
        target: /app
      - type: volume
        source: venv_shared
        target: /app/.venv
      - type: bind
        source: ~/.aws
        target: /root/.aws
        read_only: true
      - type: volume
        source: uv_cache
        target: /root/.cache/uv
    ports:
      - "8507:8505" # Different port to avoid conflicts
    networks:
      - proxy
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8505/_stcore/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    labels:
      - "traefik.enable=true"
      # Chat routes with WebSocket support
      - "traefik.http.routers.chat-test.rule=Host(`chat.test.localhost`)"
      - "traefik.http.routers.chat-test.entrypoints=websecure"
      - "traefik.http.routers.chat-test.tls=true"
      - "traefik.http.routers.chat-test.tls.options=test@file"
      - "traefik.http.routers.chat-test.service=chat-test"
      - "traefik.http.routers.chat-test.middlewares=cors-test@file,security-headers-test@file,websocket-test@file"
      - "traefik.http.services.chat-test.loadbalancer.server.port=8505"
      # Enable sticky sessions for WebSocket connections
      - "traefik.http.services.chat-test.loadbalancer.sticky.cookie=true"
      - "traefik.http.services.chat-test.loadbalancer.sticky.cookie.name=chat-test-session"
    restart: unless-stopped
    depends_on:
      api:
        condition: service_started  # Wait for API to initialize shared venv first
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "chat-test"

  # Test scheduler - enabled for scheduler tests
  scheduler:
    build:
      context: .
      target: testing
    container_name: ichrisbirch-scheduler-testing
    command: uv run python -m ichrisbirch.wsgi_scheduler
    environment:
      - ENVIRONMENT=testing
      - LOG_FORMAT=${LOG_FORMAT:-console}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - LOG_COLORS=${LOG_COLORS:-true}
      # AWS credentials for SSM parameter access (optional for local development)
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN:-}
      - AWS_REGION=${AWS_REGION:-us-east-2}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-2}
    volumes:
      - type: bind
        source: .
        target: /app
      - type: volume
        source: venv_shared
        target: /app/.venv
      - type: bind
        source: ~/.aws
        target: /root/.aws
        read_only: true
      - type: volume
        source: uv_cache
        target: /root/.cache/uv
    networks:
      - default
    restart: unless-stopped
    depends_on:
      api:
        condition: service_started  # Wait for API to initialize shared venv first
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    working_dir: /app
    healthcheck:
      disable: true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "scheduler-test"

networks:
  proxy:
    external: true
  default:
    driver: bridge

volumes:
  uv_cache:
    driver: local
  venv_shared:
    driver: local
  traefik_test_letsencrypt:
    driver: local
